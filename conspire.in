#!/bin/sh
#
# Launcher for conspire.
# This launches conspire's backend (the IRC client), and any user-installed
# servers. In this case, it's installed to `@libdir@/@PACKAGE@'.
#
# Additionally, it tries to load any XChat plugins.
#

exec_prefix=@exec_prefix@
libdir=@libdir@/@PACKAGE@
xchatplugindir=@libdir@/xchat/plugins

CONSPIRE_INTERFACE=gtk

echo "I: conspire launcher @VERSION@"

if [ -f $HOME/.conspire/launcher_settings ]; then
	. $HOME/.conspire/launcher_settings
	echo "I: Loaded settings from $HOME/.conspire/launcher_settings."
fi

PLUGINDIRS="${libdir} ${userplugindirs}"

echo "I: Starting client."

cmd="conspire-${CONSPIRE_INTERFACE} $*"
echo "I: Command: '$cmd'"
$cmd &

echo "I: Waiting for client to settle."
sleep 3

echo "I: Client started."

echo "I: Starting plugin load."

for dir in $PLUGINDIRS; do
	for server in $dir/*; do
		echo "I: Launching $server.";
		$server > /dev/null 2>&1 &
	done
done

echo "I: Plugin load complete."

if [ -d $xchatplugindir ]; then
	echo "I: Attempting to load xchat plugins."

	for plugin in $xchatplugindir/*.so; do
		echo "I: Launching xchat plugin $plugin."
		conspire-xchatwrap $plugin > /dev/null 2>&1 &
	done

	echo "I: XChat plugin load complete."
fi
